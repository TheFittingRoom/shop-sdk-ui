name: Semantic Versioning
on:
  pull_request:
    branches:
      - main
    types: [opened, edited, labeled, unlabeled, synchronize]

permissions:
  contents: write

jobs:
  get_version_label:
    runs-on: ubuntu-latest
    outputs:
      version_label: ${{ steps.get_version_label.outputs.version_label }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"
          cache: 'npm'

      - name: Require patch/minor/major label
        id: get_version_label
        uses: actions/github-script@v7
        with:
          script: |
            const allowed = ['patch', 'minor', 'major'];
            const versionLabels = context.payload.pull_request.labels.map(l => l.name.toLowerCase()).filter(label => allowed.includes(label));

            if (versionLabels.length === 0) {
              core.setFailed(`PR must contain one of the version labels: ${allowed.join(', ')}`);
            } else if (versionLabels.length > 1) {
              core.setFailed(`PR contains multiple version labels: ${versionLabels.join(', ')}. Only one of ${allowed.join(', ')} is allowed.`);
            }
            core.setOutput('version_label', versionLabels[0]);
            core.info(`version_label: ${versionLabels[0]}`);

      - name: Check Version
        id: check_feature_tags
        run: |
          VERSION_LABEL="${{ steps.get_version_label.outputs.version_label }}"

          if git describe --tags --exact-match --contains "$VERSION_LABEL" $(git rev-list origin/main..HEAD) &>/dev/null; then
            echo "version_bump_exists=true" >> $GITHUB_OUTPUT
            echo "Version bump tag '$VERSION_LABEL' already exists on feature branch"
          else
            echo "version_bump_exists=false" >> $GITHUB_OUTPUT
            echo "No '$VERSION_LABEL' tag found on feature branch"
          fi

      - name: Bump Version
        if: ${{ steps.check_feature_tags.outputs.version_bump_exists == 'false' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          VERSION_LABEL="${{ steps.get_version_label.outputs.version_label }}"
          npm version "$VERSION_LABEL" --no-git-tag-version

          NEW_VERSION=$(node -p "require('./package.json').version")

          git add package.json package-lock.json
          git commit -m "ci: bump version to $NEW_VERSION"
          git tag -a "$VERSION_LABEL" -m "Version $NEW_VERSION"
          git push origin HEAD:${{ github.event.pull_request.head.ref }} --follow-tags
